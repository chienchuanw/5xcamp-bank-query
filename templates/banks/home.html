{% extends "shared/base.html" %}
{% load custom_filters %}

{% block title %}- 首頁{% endblock title %}

{% block content %}
<div x-data="{ 
	openBankOption: false, 
	openBranchOption: false, 
	bankSearch: '', 
	branchSearch: '',
	selectedBank: '',
	selectedBranch: '',
	selectedBankId: '',
	banks: {{ banks_json }}, 
	branches: {{ branches_json }}, 
	get filteredBanks() {
		const search = this.bankSearch.trim();
		if (search === '') return this.banks;
		const searchWords = search.split(' ').filter(word => word);
		return this.banks.filter(bank => {
			const bankInfo = `${bank.code} ${bank.name}`;
			return searchWords.every(word => bankInfo.includes(word));
		});
	}, 
	get filteredBranches() {
		const search = this.branchSearch.trim();
		if (search === '') return this.branches.filter(branch => branch.bank_id == this.selectedBankId);
		const searchWords = search.split(' ').filter(word => word);
		return this.branches.filter(branch => {
			const branchInfo = `${branch.branch_name}`;
			return searchWords.every(word => branchInfo.includes(word)) && branch.bank_id == this.selectedBankId;
		});
	},
}">
	<!-- test -->
	<div>
		<span x-text="`${branches[0].bank_id} ${branches[0].branch_name}`" class="block"></span>
		<span x-text="`${banks[0].id} ${banks[0].name}`" class="block"></span>
	</div>
	<!-- test -->
  <div class="max-w-md mx-auto my-10">
    <label for="bank-search" class="mb-2 text-sm font-medium text-gray-900 sr-only dark:text-white">搜尋</label>
    <div class="relative" @click.away="openBankOption = false">
      <div class="absolute inset-y-0 start-0 flex items-center ps-3 pointer-events-none">
        <svg class="w-4 h-4 text-gray-500 dark:text-gray-400" aria-hidden="true" xmlns="http://www.w3.org/2000/svg"
          fill="none" viewBox="0 0 20 20">
          <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="m19 19-4-4m0-7A7 7 0 1 1 1 8a7 7 0 0 1 14 0Z" />
        </svg>
      </div>
      <input type="search" id="bank-search"
        class="block w-full p-4 ps-10 text-sm text-gray-900 border border-gray-300 rounded-lg bg-white focus:ring-blue-500 focus:border-blue-500"
        placeholder="請輸入關鍵字或銀行代碼..." 
				@focus="openBankOption = true" 
				@input="bankSearch = $event.target.value" 
				x-model="selectedBank" />
      <button type="button"
        class="text-white absolute end-2.5 bottom-2.5 bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-4 py-2">搜尋</button>
    </div>
		<div id="bank-dropdown" 
			class="z-10 bg-white divide-y divide-gray-100 rounded-lg shadow w-full" 
			x-cloak 
			x-show="openBankOption" >
			<ul class="py-2 text-sm text-gray-700" 
				aria-labelledby="dropdownDefaultButton" >
				<template x-if="filteredBanks.length === 0">
					<li class="block px-4 py-2 hover:bg-gray-100">無相關資料</li>
				</template>
				<template x-for="bank in filteredBanks" :key="bank.code">
					<li class="block px-4 py-2 hover:bg-gray-100" 
						x-text="`${bank.code} ${bank.name}`"
						@click="selectedBank = `${bank.code} ${bank.name}`; selectedBankId = bank.id; openBankOption = false; selectedBranch = ''"
						@mouseover="selectedBank = `${bank.code} ${bank.name}`">
					</li>
				</template>
			</ul>
		</div>
  </div>
	<div class="max-w-md mx-auto my-10">
    <label for="branch-search" class="mb-2 text-sm font-medium text-gray-900 sr-only dark:text-white">搜尋</label>
    <div class="relative" @click.away="openBranchOption = false">
      <div class="absolute inset-y-0 start-0 flex items-center ps-3 pointer-events-none">
        <svg class="w-4 h-4 text-gray-500 dark:text-gray-400" aria-hidden="true" xmlns="http://www.w3.org/2000/svg"
          fill="none" viewBox="0 0 20 20">
          <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="m19 19-4-4m0-7A7 7 0 1 1 1 8a7 7 0 0 1 14 0Z" />
        </svg>
      </div>
      <input type="search" id="branch-search" disabled
        class="block w-full p-4 ps-10 text-sm text-gray-900 border border-gray-300 rounded-lg bg-gray-200 focus:ring-blue-500 focus:border-blue-500"
        placeholder="請選擇分行名稱" 
				@focus="openBranchOption = true" 
				x-effect="
            if (selectedBank === '') {
                $el.setAttribute('disabled', true);
                $el.classList.add('bg-gray-200');
                $el.classList.remove('bg-white');
            } else {
                $el.removeAttribute('disabled');
                $el.classList.add('bg-white');
                $el.classList.remove('bg-gray-200');
            }
        "
				x-model="selectedBranch"
				@input="branchSearch = $event.target.value"   />
      <button type="button"
        class="text-white absolute end-2.5 bottom-2.5 bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-4 py-2">搜尋</button>
    </div>
		<div id="branch-dropdown" class="z-10 bg-white divide-y divide-gray-100 rounded-lg shadow w-full" x-cloak x-show="openBranchOption">
			<ul class="py-2 text-sm text-gray-700" aria-labelledby="dropdownDefaultButton">
				<template x-if="filteredBranches.length === 0">
					<li class="block px-4 py-2 hover:bg-gray-100">無相關資料</li>
				</template>
				<template x-for="branch in filteredBranches">
					<li class="block px-4 py-2 hover:bg-gray-100" 
						x-text="`${branch.branch_name}`"
						@click="selectedBranch = `${branch.branch_name}`; openBranchOption = false"
						@mouseover="selectedBranch = `${branch.branch_name}`">
					</li>
				</template>
				
			</ul>
		</div>
  </div>
</div>
{% endblock content %}